---
title: "Participant characteristics"
author: "baf44"
date: "12/8/2022"
output: html_document
editor_options: 
  chunk_output_type: console
---
```{r load packages }
# load packages
library(data.table)
library(boot) 
library(table1)
library(ggplot2)
library(dplyr)
library(haven)
library(reshape2)
```

```{r load generated datasets, include=FALSE}

# these are generated and exported by data_org.R

censor_sum <- read.csv("data/compiled/censorp_byrun.csv")
compiled <- read.csv("data/compiled/demographics_compiled.csv")

```

```{r generate demo variables}

#### Fat Mass Index ####
# height in meters 
compiled$height_avg_meters <- NA
compiled$height_avg_meters <- (compiled$height_avg)*.01

# FMI
compiled$dxa_total_fat_mass_kg <- as.numeric(compiled$dxa_total_fat_mass)/1000
compiled$FMI <- NA
compiled$FMI <- compiled$dxa_total_fat_mass_kg / (compiled$height_avg_meters)^2

#### Income ####
# orig coding (0'<$20K' 1'$20-35,999K' 2'$36-50,999K' 3'$51-75,999K' 4'$76-100K' 5'>$100K')

# make income_recode variable with 3 brackets: >51k, 51-100k, >100k
compiled$income_recode <- NA
compiled$income_recode[compiled$income < 3] <- 0
compiled$income_recode[compiled$income == 3 ] <- 1
compiled$income_recode[compiled$income == 4 ] <- 1
compiled$income_recode[compiled$income == 5 ] <- 2

compiled$income_recode <- factor(compiled$income_recode, levels=c(0,1,2),
         labels=c("< $51,000K", 
                  "51-100K",
                  "> $100K"))

#### Maternal education ####
# Make maternal education variable based on parent_ed and parent_respondent
compiled$mom_edu <- NA
compiled$mom_edu_other <- NA
for (i in 1:nrow(compiled)) {
  if((compiled$parent_respondent[i] == 0)) {
    compiled$mom_edu[i] <- compiled$parent_ed[i]
    compiled$mom_edu_other[i] <- compiled$parent_ed_other[i]
  }
  else {
    compiled$mom_edu[i] <- compiled$partner_ed[i]
    compiled$mom_edu_other[i] <- compiled$partner_ed_other[i]
  }
}

# Original levels: (0=HighSchool,  1=Associates, 2=Technical, 3=Bachelors, 4=masters, 5=PhD, 6=MD, 7=JD, 8=Other)

# Create new maternal education variable with 3 levels (0= >BA, 1=BA, 2=>BA, 3=other)
compiled$mom_edu_recode <- NA
compiled$mom_edu_recode[compiled$mom_edu < 3] <- 0
compiled$mom_edu_recode[compiled$mom_edu == 3 ] <- 1
compiled$mom_edu_recode[compiled$mom_edu > 3 & compiled$mom_edu < 8 ] <- 2
#compiled$mom_edu_recode[compiled$mom_edu == 8 ] <- 3 #there are no "Other"s
compiled$mom_edu_recode <- factor(compiled$mom_edu_recode, levels=c(0,1,2),
         labels=c("< BA", 
                  "BA",
                  "> BA"))

#### Maternal BMI ####
compiled$mom_bmi <- NA
compiled$mom_bmi_method <- NA
for (i in 1:nrow(compiled)) {
  if((compiled$parent_respondent[i] == 0)) {
    compiled$mom_bmi[i] <- compiled$parent_bmi[i] #parent_bmi is from measured height/weight
    compiled$mom_bmi_method[i] <- "measured"
  }
  else {
    compiled$mom_bmi[i] <- compiled$sr_mom_bmi[i] #sr_mom_bmi is from self-report height/weight
    compiled$mom_bmi_method[i] <- "reported"
  }
}
```

```{r summarize scan status}
# count the number of runs completed per subject
compiled$n_run_complete <- rowSums(compiled[ , c("fmri_pp_scans_roar___2","fmri_pp_scans_roar___3", "fmri_pp_scans_roar___4","fmri_pp_scans_roar___5","fmri_pp_scans_roar___6")])

# count the number of runs per subject with less than 20% of interest_TRs censored
run_count <- censor_sum %>% group_by(id) %>% summarise(n_run_good = sum(p_censor_interest < 20))

# add run_count to attended_v6
compiled<-merge(x=compiled,y=run_count,by="id",all.x=TRUE)

# make variable for exclusion rationale
compiled$exc_rationale <- NA

for (i in 1:nrow(compiled)) {
  if(compiled$fmri_pp_complete[i] == 0) {
    compiled$exc_rationale[i] <- "withdrew from MRI"
  }
  else if(compiled$id[i] == 69) {
    compiled$exc_rationale[i] <- "STILL PROCESSING"
  }
  else if(compiled$n_run_complete[i] <3) {
    compiled$exc_rationale[i] <- "withdrew <3 runs"
  }
  else if(compiled$n_run_good[i] < 3) {
    compiled$exc_rationale[i] <- "motion"
  }
  else if(compiled$id[i] == 105 | compiled$id[i] == 119) {
    compiled$exc_rationale[i] <- "FOV"
  }
}

# frequency of each exclusion rationale
table(compiled$exc_rationale)

```

```{r set pre-MRI fullness variable }

compiled$pre_mri_ff <- NA

for (i in 1:nrow(compiled)) {
  if(!is.na(compiled$ff_postmri_snack2[i])){
    compiled$pre_mri_ff[i] <- compiled$ff_postmri_snack2[i]
  }
  else if(!is.na(compiled$ff_postmri_snack[i])) {
    compiled$pre_mri_ff[i] <- compiled$ff_postmri_snack[i]
  }
  else if(!is.na(compiled$ff_premri_snack[i])) {
  compiled$pre_mri_ff[i] <- compiled$ff_premri_snack[i]
  }
}

```

```{r concat dataframes and subset}

# copy 'compiled' to a new dataframe for subsequent steps so that 'compiled' remains untouched
attended_df <- compiled

# isolate subjects who were scanned on V6
scanned_df <- compiled2[compiled2$fmri_pp_complete == 1, ]

# isolate subjects included in imaging analyses
analyzed_df <- compiled2[compiled2$included == 1, ]

```


```{r make table: included vs excluded}

## note: if want to include all children who attended V6 --- can use 'attended_df' df
## note: if want to include all children who were scanned --- can use 'scanned_df' df 

# prepare variables
attended_df$risk_status_mom <- factor(attended_df$risk_status_mom, levels=c(0,1,2),
         labels=c("Low Risk", 
                  "High Risk",
                  "Neither"))

attended_df$included <- factor(attended_df$included, levels=c(0,1),
         labels=c("Excluded", 
                  "Included"))

attended_df$sex <- factor(attended_df$sex, levels=c(0,1),
                            labels=c("Male", 
                                "Female"))

attended_df$race <- factor(attended_df$race, levels=c(0,1,2,3,4),
                            labels=c("White", 
                                "American Indian/Alaskan Native",
                                "Asian",
                                "Black/African American",
                                "Hawaiian/Pacific Islander"))

label(attended_df$sex) <- "Sex"
label(attended_df$race) <- "Race"
label(attended_df$risk_status_mom)  <- "Risk Status"
label(attended_df$age_yr) <- "Age, yrs"
label(attended_df$income_recode) <- "Family Income"
label(attended_df$mom_edu_recode) <- "Maternal Education"
label(attended_df$FMI) <- "Fat mass index"


# generate table
table1(~ risk_status_mom + sex + age_yr + race + income_recode + mom_edu_recode + FMI| included, data=attended_df)
```

```{r compare: included vs excluded}

# age
t.test(attended_df$age ~ attended_df$included, var.equal = TRUE)

# sex
chisq.test(attended_df$included, attended_df$sex, correct=TRUE)

# maternal education
chisq.test(attended_df$included, attended_df$mom_edu_recode, correct=TRUE)

# income
chisq.test(attended_df$included, attended_df$income_recode, correct=TRUE)

# mom bmi
t.test(attended_df$mom_bmi ~ attended_df$included, var.equal = TRUE)

# risk
chisq.test(attended_df$included, attended_df$risk_status_mom, correct=TRUE)

# FMI
t.test(attended_df$FMI ~ attended_df$included, var.equal = TRUE)



```

```{r make table: participant characteristics risk}

# prepare variables for table
analyzed_df$dxa_subtotal_perc_fat <- as.numeric(analyzed_df$dxa_subtotal_perc_fat)

analyzed_df$sex <- factor(analyzed_df$sex, levels=c(0,1),
                            labels=c("Male", 
                                "Female"))

analyzed_df$risk_status_mom <- factor(analyzed_df$risk_status_mom, levels=c(0,1,2),
         labels=c("Low Risk", 
                  "High Risk",
                  "Neither"))

# set labels
label(analyzed_df$sex) <- "Sex"
label(analyzed_df$risk_status_mom)  <- "Risk Status"
label(analyzed_df$bmi_percentile)     <- "BMI percentile"
label(analyzed_df$FMI) <- "Fat mass index"
label(analyzed_df$age_yr) <- "Age, yrs"
label(analyzed_df$income_recode) <- "Family Income"
label(analyzed_df$mom_edu_recode) <- "Maternal Education"
label(analyzed_df$mom_bmi) <- "Maternal BMI"
label(analyzed_df$pre_mri_ff)     <- "Pre-MRI fullness"
label(analyzed_df$n_run_good)     <- "Number of analyzed runs"
label(analyzed_df$fd_avg_allruns)     <- "Average framewise displacement"


# generate table
table1(~ sex + age_yr + bmi_percentile + FMI + income_recode + mom_edu_recode + mom_bmi + pre_mri_ff + n_run_good + fd_avg_allruns| risk_status_mom, data=analyzed_df)
table1(~ sex + age_yr + bmi_percentile + FMI + income_recode + mom_edu_recode + mom_bmi + pre_mri_ff + fd_avg_allruns| risk_status_mom, data=analyzed_df)


# count measured vs. reported BMI
table(analyzed_df$mom_bmi_method)


```


```{r compare: by risk}

# age
t.test(analyzed_df$age ~ analyzed_df$risk_status_mom, var.equal = TRUE)

# sex
t.test(analyzed_df$sex ~ analyzed_df$risk_status_mom, var.equal = TRUE)

# maternal education
chisq.test(analyzed_df$risk_status_mom, analyzed_df$mom_edu_recode, correct=TRUE)

# income
chisq.test(analyzed_df$risk_status_mom, analyzed_df$income_recode, correct=TRUE)

# mom bmi
t.test(analyzed_df$mom_bmi ~ analyzed_df$risk_status_mom, var.equal = TRUE)

# pre-mri fullness
t.test(analyzed_df$pre_mri_ff ~ analyzed_df$risk_status_mom, var.equal = TRUE)

# good run count
t.test(analyzed_df$n_run_good ~ analyzed_df$risk_status_mom, var.equal = TRUE)

# average motion
t.test(analyzed_df$fd_avg_allruns ~ analyzed_df$risk_status_mom, var.equal = TRUE)

```
